<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è·¯ç”±ç­–ç•¥ç®¡ç†</title>
  <link href="/bootstrap.min.css" rel="stylesheet"/>
  <script src="/axios.min.js"></script>
  <style>
    body { background:#f7f7f9; }
    .page-wrap { display:flex; height: calc(100vh - 70px); }
    .sidebar {
      width: 320px; max-width: 45vw; background:#fff; border-right:1px solid #e5e7eb;
      display:flex; flex-direction:column;
    }
    .sidebar .header {
      padding: 10px 12px; border-bottom:1px solid #e5e7eb; font-weight:600;
      display:flex; gap:8px; align-items:center; justify-content:space-between;
    }
    .header-left { display:flex; align-items:center; gap:8px; }
    .search-box { width:100%; }
    .list { list-style:none; margin:0; padding:0; overflow:auto; }
    .list-item {
      padding:10px 12px; border-bottom:1px solid #f2f2f2; cursor:pointer; user-select:none;
      display:flex; align-items:center; gap:10px;
    }
    .list-item:hover { background:#f6f8fa; }
    .list-item.active { background:#e8f0fe; }
    .item-main { flex:1; min-width:0; }
    .item-main strong { display:block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .item-main small { color:#6b7280; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:block; }
    .item-actions { display:flex; align-items:center; gap:6px; }
    .btn-icon { border:0; background:transparent; padding:4px 6px; border-radius:6px; }
    .btn-icon:hover { background:#f1f5f9; }
    .content { flex:1; display:flex; flex-direction:column; }
    .toolbar { background:#fff; border-bottom:1px solid #e5e7eb; padding:10px 16px; display:flex; gap:8px; align-items:center; }
    .editor-wrap { padding:16px; overflow:auto; display:flex; flex-direction:column; gap:12px; }
    .form-row { display:flex; gap:12px; flex-wrap:wrap; }
    .form-row .form-group { flex:1; min-width: 220px; }
    .code-editor {
      width:100%; height: 60vh; border:1px solid #ced4da; border-radius:6px; overflow:hidden;
      /* Monaco è‡ªå¸¦ä¸»é¢˜ï¼Œè¿™é‡Œåªè´Ÿè´£å°ºå¯¸ä¸è¾¹æ¡† */
      background:#0d1117;
    }
    .status { margin-left:auto; color:#6b7280; font-size: 0.9rem; }
    .pill { padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; font-size:12px; }
  </style>
</head>
<body>
  <div class="container-fluid p-0">
    <nav class="navbar navbar-expand-lg navbar-light bg-light px-3" style="border-bottom:1px solid #e5e7eb;">
      <a class="navbar-brand" href="#">è·¯ç”±ç­–ç•¥</a>
      <div class="collapse navbar-collapse">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="/">è¾“å…¥ä¿¡æ¯</a></li>
          <li class="nav-item"><a class="nav-link" href="/sim.html">ä»¿çœŸç»“æœ</a></li>
          <li class="nav-item"><a class="nav-link active" href="#">è·¯ç”±ç­–ç•¥</a></li>
          <li class="nav-item"><a class="nav-link" href="/schedCode.html">è°ƒåº¦ç­–ç•¥</a></li>
          <li class="nav-item"><a class="nav-link" href="/history.html">å†å²ä»¿çœŸ</a></li>
        </ul>
      </div>
    </nav>

    <div class="page-wrap">
      <!-- å·¦ä¾§ï¼šç­–ç•¥åˆ—è¡¨ -->
      <aside class="sidebar">
        <div class="header">
          <div class="header-left">
            <span>ç­–ç•¥</span>
            <span id="countBadge" class="pill">0</span>
          </div>
          <button id="btnNewInSidebar" class="btn btn-primary btn-sm">æ–°å»ºç­–ç•¥</button>
        </div>

        <div class="p-2">
          <input id="searchInput" class="form-control search-box" placeholder="æœç´¢ç­–ç•¥åâ€¦"/>
        </div>

        <ul id="strategyList" class="list"></ul>
      </aside>

      <!-- å³ä¾§ï¼šç¼–è¾‘åŒº -->
      <main class="content">
        <div class="toolbar">
          <!-- ä¸»æŒ‰é’®ï¼šæ–°å»º=ä¸Šä¼ ï¼›ç¼–è¾‘=ä¿®æ”¹ -->
          <button id="btnPrimary" class="btn btn-success btn-sm" disabled>ä¿®æ”¹</button>
          <span id="opStatus" class="status"></span>
        </div>

        <div class="editor-wrap">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ç­–ç•¥åï¼ˆnameï¼‰</label>
              <input id="strategyName" class="form-control" placeholder="ä¾‹å¦‚ï¼šMyShortestPath" />
            </div>
            <div class="form-group">
              <label class="form-label">æ–‡ä»¶åï¼ˆfilenameï¼‰</label>
              <input id="fileName" class="form-control" placeholder="ä¾‹å¦‚ï¼šCustomRouteStrategy.cpp" />
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label">ä»£ç å†…å®¹</label>
            <div id="codeEditor" class="code-editor"></div>
          </div>

          <div id="helpText" class="text-muted" style="font-size:0.9rem;">
            æ–°å»ºæ¨¡å¼ï¼šå¯å¡«å†™ç­–ç•¥åã€æ–‡ä»¶åä¸ä»£ç ï¼Œç‚¹å‡»â€œä¸Šä¼ â€ã€‚<br/>
            ç¼–è¾‘æ¨¡å¼ï¼šåªèƒ½ä¿®æ”¹ä»£ç ï¼Œç­–ç•¥åä¸æ–‡ä»¶åä¸å¯ä¿®æ”¹ï¼Œç‚¹å‡»â€œä¿®æ”¹â€ã€‚
          </div>
          <div id="uploadResult" class="mt-2"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- Monaco AMD Loaderï¼ˆéœ€åœ¨ä½ è‡ªå·±çš„ <script> ä¹‹å‰ï¼‰ -->
  <!-- <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs/loader.js"></script> -->
  <script src="/public/monaco/vs/loader.js"></script>

  <script>
    const apiBaseUrl = "/api/v1";
    let strategies = [];
    let filtered = [];
    let selectedId = null;
    let mode = "view"; // "view" | "edit" | "new"

    // refs
    const elList = document.getElementById('strategyList');
    const elSearch = document.getElementById('searchInput');
    const elCount = document.getElementById('countBadge');
    const elName = document.getElementById('strategyName');
    const elFile = document.getElementById('fileName');
    const elPrimary = document.getElementById('btnPrimary');
    const elNewSidebar = document.getElementById('btnNewInSidebar');
    const elStatus = document.getElementById('opStatus');
    const elUploadResult = document.getElementById('uploadResult');

    // Monaco å®ä¾‹ä¸å°è£…
    let monacoEditor = null;
    function getCode() {
      return monacoEditor ? monacoEditor.getValue() : '';
    }
    function setCode(val) {
      if (monacoEditor) monacoEditor.setValue(val || '');
    }

    const defaultTemplate = `#include "Alg/Route/CustomRouteStrategy.h"
#include "Alg/Network.h"

using namespace route;
extern "C" route::CustomRouteStrategy* createRouteStrategy(CNetwork* net) {
    return new route::CustomRouteStrategy(net);
}
bool CustomRouteStrategy::Route(NODEID sourceId, NODEID sinkId, std::list<NODEID>& nodeList, std::list<LINKID>& linkList) {
    // è‡ªå®šä¹‰è·¯ç”±ç®—æ³•å®ç°
    // è·å–ç½‘ç»œä¸­èŠ‚ç‚¹çš„æ€»æ•°
    UINT NodeNum = static_cast<UINT>(net->m_vAllNodes.size());

    // ç”¨äºè®°å½•æ¯ä¸ªèŠ‚ç‚¹åœ¨æœ€çŸ­è·¯å¾„ä¸­çš„å‰é©±èŠ‚ç‚¹ï¼Œåˆå§‹åŒ–ä¸º -1
    vector<NODEID> preNode(NodeNum, -1);

    // ç”¨äºè®°å½•æ¯ä¸ªèŠ‚ç‚¹æ˜¯å¦å·²è¢«è®¿é—®ï¼Œåˆå§‹åŒ–ä¸º false
    vector<bool> visited(NodeNum, false);

    // é˜Ÿåˆ—ç”¨äºè¿›è¡Œå¹¿åº¦ä¼˜å…ˆæœç´¢ï¼ˆBFSï¼‰
    queue<NODEID> toVisit;

    // å°†æºèŠ‚ç‚¹åŠ å…¥å¾…è®¿é—®é˜Ÿåˆ—å¹¶æ ‡è®°ä¸ºå·²è®¿é—®
    toVisit.push(sourceId);
    visited[sourceId] = true;

    // å¼€å§‹è¿›è¡Œ BFS æœç´¢
    while (!toVisit.empty())
    {
        NODEID curNode = toVisit.front();
        toVisit.pop();

        if (curNode == sinkId) { break; }

        for (auto it = net->m_vAllNodes[curNode].m_lAdjNodes.begin();
             it != net->m_vAllNodes[curNode].m_lAdjNodes.end(); ++it)
        {
            NODEID adjNode = *it;
            LINKID linkId = net->m_mNodePairToLink[make_pair(curNode, adjNode)];

            if (net->m_vAllLinks[linkId].GetWeight() == INF) { continue; }

            if (!visited[adjNode]) {
                visited[adjNode] = true;
                preNode[adjNode] = curNode;
                toVisit.push(adjNode);
                if (adjNode == sinkId) { break; }
            }
        }
    }

    if (!visited[sinkId]) { return false; }

    NODEID curNode = sinkId;
    while (curNode != sourceId)
    {
        nodeList.push_front(curNode);
        NODEID pre = preNode[curNode];
        LINKID midLink = net->m_mNodePairToLink[make_pair(pre, curNode)];
        linkList.push_front(midLink);
        curNode = pre;
    }
    nodeList.push_front(sourceId);
    return true;
}`;

    window.addEventListener('load', async () => {
      await initMonaco();   // å…ˆåˆ›å»ºç¼–è¾‘å™¨
      bindEvents();
      await refreshList(true);
    });

    async function initMonaco() {
      return new Promise((resolve) => {
        window.require.config({
          // paths: { 'vs': 'https://cdn.jsdelivr.net/npm/monaco-editor@0.49.0/min/vs' }
          paths: { 'vs': '/public/monaco/vs' }
        });
        window.require(['vs/editor/editor.main'], function () {
          monacoEditor = monaco.editor.create(document.getElementById('codeEditor'), {
            value: '',
            language: 'cpp',
            theme: 'vs-dark',
            automaticLayout: true,
            wordWrap: 'on',
            minimap: { enabled: false },
            lineNumbers: 'on',
            scrollBeyondLastLine: false,
            fontSize: 13
          });
          monacoEditor.onDidChangeModelContent(() => updatePrimary());
          resolve();
        });
      });
    }

    function bindEvents() {
      elSearch.addEventListener('input', () => {
        const q = elSearch.value.trim().toLowerCase();
        filtered = strategies.filter(s => s.name?.toLowerCase().includes(q));
        renderList();
      });

      elNewSidebar.addEventListener('click', () => enterNewMode());
      elPrimary.addEventListener('click', () => onPrimary());

      // åç§°/æ–‡ä»¶è¾“å…¥å˜åŒ–æ—¶ï¼Œé‡æ–°è¯„ä¼°æŒ‰é’®çŠ¶æ€
      [elName, elFile].forEach(inp => {
        inp.addEventListener('input', updatePrimary);
      });
    }

    async function refreshList(selectFirst = false) {
      setStatus('åŠ è½½ä¸­â€¦');
      try {
        const resp = await axios.get(`${apiBaseUrl}/route/allUserStrategy`);
        const items = resp.data?.items || resp.data || [];
        strategies = Array.isArray(items) ? items : [];
        filtered = strategies.slice();
        renderList();

        if (selectFirst && filtered.length) {
          selectStrategy(filtered[0].id);
        } else if (selectedId) {
          const still = strategies.find(s => s.id === selectedId);
          if (!still && filtered.length) selectStrategy(filtered[0].id);
        }
        setStatus(`å…± ${strategies.length} æ¡ç­–ç•¥`);
      } catch (e) {
        console.error(e);
        setStatus('åŠ è½½å¤±è´¥');
        alert('è·å–ç­–ç•¥åˆ—è¡¨å¤±è´¥');
      }
    }

    function renderList() {
      elList.innerHTML = '';
      elCount.textContent = filtered.length;
      filtered.forEach(s => {
        const li = document.createElement('li');
        li.className = 'list-item' + (s.id === selectedId ? ' active' : '');
        li.title = s.filePath || '';

        const main = document.createElement('div');
        main.className = 'item-main';
        main.innerHTML = `
          <strong>${escapeHtml(s.name || '(æœªå‘½å)')}</strong>
          <small>${escapeHtml(shortenPath(s.filePath || ''))}</small>
        `;

        const actions = document.createElement('div');
        actions.className = 'item-actions';
        const delBtn = document.createElement('button');
        delBtn.className = 'btn-icon';
        delBtn.title = 'åˆ é™¤ç­–ç•¥';
        delBtn.innerHTML = 'ğŸ—‘ï¸';
        delBtn.addEventListener('click', (ev) => {
          ev.stopPropagation();
          onDeleteById(s.id, s.name);
        });

        actions.appendChild(delBtn);
        li.appendChild(main);
        li.appendChild(actions);

        li.addEventListener('click', () => selectStrategy(s.id));
        elList.appendChild(li);
      });
      updatePrimary();
    }

    // é€‰ä¸­ç­–ç•¥ï¼šå…ˆæ¸²æŸ“åŸºæœ¬ä¿¡æ¯ï¼Œå†å– strategyInfo/{id} æ‹‰å– code
    async function selectStrategy(id) {
      const s = strategies.find(x => x.id === id);
      if (!s) return;

      selectedId = id;
      mode = 'edit';

      elName.value = s.name || '';
      elFile.value = extractFileName(s.filePath || '');
      setCode(''); // æ¸…ç©ºï¼Œå¾…è¯¦æƒ…æ¥å£å›å¡«
      setEditable(false);
      setStatus(`è¯»å–ç­–ç•¥è¯¦æƒ…ä¸­â€¦`);
      elUploadResult.innerText = '';

      // ä¾§è¾¹é«˜äº®
      [...elList.children].forEach(li => {
        const name = li.querySelector('strong')?.textContent;
        li.classList.toggle('active', name === (s.name || '(æœªå‘½å)'));
      });

      updatePrimary();

      // æ‹‰å–å¸¦ code çš„è¯¦æƒ…
      try {
        const resp = await axios.get(`${apiBaseUrl}/route/strategyInfo/${id}`);
        const detail = resp.data || {};
        if (typeof detail.code === 'string') {
          setCode(detail.code);
        }
        setStatus(`å·²é€‰ä¸­ï¼š${detail.name || s.name || id}`);
      } catch (e) {
        console.error(e);
        setStatus('è¯»å–ç­–ç•¥ä»£ç å¤±è´¥');
        alert(`è·å–ç­–ç•¥ä»£ç å¤±è´¥ï¼š${e.response?.data || e.message}`);
      }

      updatePrimary();
    }

    function enterNewMode() {
      selectedId = null;
      mode = 'new';

      elName.value = '';
      elFile.value = 'CustomRouteStrategy.cpp';
      setCode(defaultTemplate);
      setEditable(true);
      setStatus('æ–°å»ºç­–ç•¥ï¼šå¡«å†™ç­–ç•¥åã€æ–‡ä»¶åä¸ä»£ç åç‚¹å‡»â€œä¸Šä¼ â€');
      elUploadResult.innerText = '';

      // å–æ¶ˆåˆ—è¡¨é«˜äº®
      [...elList.children].forEach(li => li.classList.remove('active'));

      updatePrimary();
    }

    function setEditable(canEditMeta) {
      elName.disabled = !canEditMeta;
      elFile.disabled = !canEditMeta;
      // è‹¥éœ€è¦æ§åˆ¶ä»£ç åªè¯»ï¼Œå¯æŒ‰éœ€åˆ‡æ¢ï¼š
      // monacoEditor?.updateOptions({ readOnly: !canEditMeta });
    }

    // ç»Ÿä¸€å¯ç”¨æ¡ä»¶ï¼šname/filename/code ä¸‰è€…éç©ºå³å¯ç”¨
    function updatePrimary() {
      const filled = !!(elName.value.trim() && elFile.value.trim() && getCode().trim());
      if (mode === 'new') {
        elPrimary.textContent = 'ä¸Šä¼ ';
        elPrimary.classList.remove('btn-success');
        elPrimary.classList.add('btn-primary');
        elPrimary.disabled = !filled;
      } else if (mode === 'edit') {
        elPrimary.textContent = 'ä¿®æ”¹';
        elPrimary.classList.remove('btn-primary');
        elPrimary.classList.add('btn-success');
        elPrimary.disabled = !filled || !selectedId;
      } else {
        elPrimary.textContent = 'ä¿®æ”¹';
        elPrimary.disabled = true;
      }
    }

    async function onPrimary() {
      if (mode === 'new') {
        await doCreate();
      } else if (mode === 'edit') {
        await doModify();
      }
    }

    async function doCreate() {
      try {
        const name = elName.value.trim();
        const filename = elFile.value.trim();
        const code = getCode();

        if (!name || !filename || !code.trim()) {
          alert('è¯·å¡«å†™å®Œæ•´ï¼šç­–ç•¥åã€æ–‡ä»¶åã€ä»£ç ');
          return;
        }
        setStatus('ä¸Šä¼ å¹¶ç¼–è¯‘ä¸­â€¦');
        const resp = await axios.post(`${apiBaseUrl}/route/upload-code`, { name, filename, code });
        handleToast(resp, 'åˆ›å»ºæˆåŠŸ', 'ç¼–è¯‘å¤±è´¥');
        await refreshList(true);
        const just = strategies.find(s => s.name === name);
        if (just) selectStrategy(just.id);
      } catch (e) {
        console.error(e);
        setStatus('ä¸Šä¼ å¤±è´¥');
        alert(`ä¸Šä¼ å¤±è´¥ï¼š${e.response?.data || e.message}`);
      }
    }

    async function doModify() {
      if (!selectedId) return;
      try {
        const code = getCode();
        setStatus('ä¿å­˜å¹¶ç¼–è¯‘ä¸­â€¦');
        const resp = await axios.post(`${apiBaseUrl}/route/modify-code/${selectedId}`, { code });
        handleToast(resp, 'ä¿å­˜æˆåŠŸ', 'ç¼–è¯‘å¤±è´¥');
        await refreshList(false);
      } catch (e) {
        console.error(e);
        setStatus('ä¿å­˜å¤±è´¥');
        alert(`ä¿å­˜å¤±è´¥ï¼š${e.response?.data || e.message}`);
      }
    }

    async function onDeleteById(id, name) {
      const ok = confirm(`ç¡®è®¤åˆ é™¤ç­–ç•¥ã€Œ${name || id}ã€ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`);
      if (!ok) return;

      try {
        setStatus('åˆ é™¤ä¸­â€¦');
        const resp = await axios.post(`${apiBaseUrl}/route/delete/${id}`);
        if (resp.status === 200) {
          setStatus('åˆ é™¤æˆåŠŸ');
          if (selectedId === id) {
            selectedId = null;
            mode = 'view';
            elName.value = '';
            elFile.value = '';
            setCode('');
            elUploadResult.innerText = '';
            setEditable(false);
          }
          await refreshList(true);
        } else {
          setStatus('åˆ é™¤å¤±è´¥');
          alert(`åˆ é™¤å¤±è´¥ï¼š${resp.data || resp.status}`);
        }
      } catch (e) {
        console.error(e);
        setStatus('åˆ é™¤å¤±è´¥');
        alert(`åˆ é™¤å¤±è´¥ï¼š${e.response?.data || e.message}`);
      }
    }

    function handleToast(resp, okMsg, failMsg) {
      if (resp.status === 200) {
        elUploadResult.innerText = `${okMsg}ï¼š${resp.data}`;
        alert(`${okMsg}ï¼š${resp.data}`);
        setStatus(okMsg);
      } else {
        elUploadResult.innerText = `${failMsg}ï¼š${resp.data}`;
        alert(`${failMsg}ï¼š${resp.data}`);
        setStatus(failMsg);
      }
    }

    function setStatus(t) { elStatus.textContent = t || ''; }

    // utils
    function escapeHtml(s) {
      return (s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function extractFileName(path) {
      if (!path) return '';
      const i = path.lastIndexOf('/');
      return i >= 0 ? path.slice(i+1) : path;
    }
    function shortenPath(path) {
      if (!path) return '';
      if (path.length <= 42) return path;
      return 'â€¦' + path.slice(-40);
    }
  </script>
</body>
</html>
